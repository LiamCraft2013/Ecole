<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Scolaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://hsercitkdpjgftcnctze.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzZXJjaXRrZHBqZ2Z0Y25jdHplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4ODY0ODcsImV4cCI6MjA3ODQ2MjQ4N30.LY66K60q4NXV4A_MzVWL9Dd5rhov9ihFUUvbfDFsPSI';

        const supabase = {
            from: (table) => ({
                select: async () => {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*`, {
                        headers: {'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`}
                    });
                    return {data: await res.json()};
                },
                insert: async (data) => {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation'},
                        body: JSON.stringify(data)
                    });
                    return {data: await res.json()};
                },
                update: async (data) => ({
                    eq: async (col, val) => {
                        const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${col}=eq.${val}`, {
                            method: 'PATCH',
                            headers: {'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation'},
                            body: JSON.stringify(data)
                        });
                        return {data: await res.json()};
                    }
                }),
                delete: async () => ({
                    eq: async (col, val) => {
                        await fetch(`${SUPABASE_URL}/rest/v1/${table}?${col}=eq.${val}`, {
                            method: 'DELETE',
                            headers: {'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`}
                        });
                        return {};
                    }
                })
            })
        };

        let S = {
            user: null, tab: 'dashboard', loading: true,
            accounts: [], classes: [], students: [], messages: [], alerts: [], attendance: [], homework: [], schedules: [],
            showForm: null, editData: null
        };

        async function init() {
            S.loading = true;
            render();
            const [a,c,s,m,al,at,h,sc] = await Promise.all([
                supabase.from('accounts').select(),
                supabase.from('classes').select(),
                supabase.from('students').select(),
                supabase.from('messages').select(),
                supabase.from('alerts').select(),
                supabase.from('attendance').select(),
                supabase.from('homework').select(),
                supabase.from('schedules').select()
            ]);
            S.accounts = a.data || []; S.classes = c.data || []; S.students = s.data || [];
            S.messages = m.data || []; S.alerts = al.data || []; S.attendance = at.data || [];
            S.homework = h.data || []; S.schedules = sc.data || [];
            S.loading = false;
            render();
        }

        function render() {
            const app = document.getElementById('app');
            if (S.loading) {
                app.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center"><div class="text-white text-2xl">Chargement...</div></div>';
                return;
            }
            if (!S.user) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div class="text-6xl text-center mb-4">üè´</div>
                            <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Connexion</h1>
                            <input type="text" id="u" placeholder="Nom d'utilisateur" class="w-full px-4 py-3 mb-4 border rounded-lg">
                            <input type="password" id="p" placeholder="Mot de passe" class="w-full px-4 py-3 mb-4 border rounded-lg" onkeypress="if(event.key==='Enter')login()">
                            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Se connecter</button>
                            <p class="text-sm text-gray-500 text-center mt-4">Supabase ‚úì</p>
                        </div>
                    </div>
                `;
                return;
            }

            const isAdmin = S.user.role === 'admin';
            const tc = S.classes.find(c => c.teacher_id === S.user.id);

            app.innerHTML = `
                <div class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">üè´</div>
                            <div>
                                <h1 class="text-2xl font-bold">Gestion Scolaire</h1>
                                <p class="text-sm text-gray-600">${S.user.name} - ${isAdmin ? 'Admin' : 'Enseignant'}</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">D√©connexion</button>
                    </div>
                </div>
                <div class="max-w-7xl mx-auto px-4 py-6">
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                        ${btn('dashboard', 'üìä Tableau')}
                        ${isAdmin ? `
                            ${btn('accounts', 'üë• Comptes')}
                            ${btn('classes', 'üè´ Classes')}
                            ${btn('students', 'üéì √âl√®ves')}
                            ${btn('attendance-view', '‚úì Appels')}
                            ${btn('alerts', 'üö® Alertes')}
                        ` : `
                            ${btn('alerts', 'üö® Alertes')}
                            ${btn('attendance', '‚úì Appel')}
                            ${btn('schedule', 'üïê Emploi')}
                        `}
                        ${btn('messages', 'üí¨ Messages')}
                        ${btn('homework', 'üìö Devoirs')}
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">${getContent()}</div>
                </div>
            `;
        }

        function btn(t, l) {
            return `<button onclick="tab('${t}')" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap ${S.tab===t?'bg-blue-600 text-white':'bg-white text-gray-700 hover:bg-gray-100'}">${l}</button>`;
        }

        function getContent() {
            const isAdmin = S.user.role === 'admin';
            const tc = S.classes.find(c => c.teacher_id === S.user.id);

            if (S.tab === 'dashboard') {
                return `
                    <h2 class="text-2xl font-bold mb-6">Tableau de bord</h2>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-100 p-6 rounded-lg text-center"><div class="text-4xl mb-2">üë•</div><h3 class="text-3xl font-bold text-blue-600">${S.students.length}</h3><p>√âl√®ves</p></div>
                        <div class="bg-green-100 p-6 rounded-lg text-center"><div class="text-4xl mb-2">üè´</div><h3 class="text-3xl font-bold text-green-600">${S.classes.length}</h3><p>Classes</p></div>
                        <div class="bg-purple-100 p-6 rounded-lg text-center"><div class="text-4xl mb-2">üí¨</div><h3 class="text-3xl font-bold text-purple-600">${S.messages.length}</h3><p>Messages</p></div>
                    </div>
                    ${!isAdmin && S.alerts.length > 0 ? `
                        <h3 class="text-xl font-bold mb-4">üö® Alertes importantes</h3>
                        ${S.alerts.slice(-5).reverse().map(a => `
                            <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded mb-2">
                                <p class="font-bold text-red-800">${a.title}</p>
                                <p class="text-sm">${a.description}</p>
                                <p class="text-xs text-gray-500 mt-1">Par ${a.created_by} - ${new Date(a.date).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    ` : ''}
                `;
            }

            if (S.tab === 'accounts' && isAdmin) {
                return `
                    <div class="flex justify-between mb-6">
                        <h2 class="text-2xl font-bold">Comptes</h2>
                        <button onclick="showForm('account')" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚ûï Cr√©er</button>
                    </div>
                    ${S.showForm === 'account' ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <input type="text" id="name" placeholder="Nom complet" class="w-full px-3 py-2 mb-2 border rounded">
                            <input type="text" id="username" placeholder="Username" class="w-full px-3 py-2 mb-2 border rounded">
                            <input type="password" id="password" placeholder="Password" class="w-full px-3 py-2 mb-2 border rounded">
                            <button onclick="createAccount()" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Cr√©er</button>
                            <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                        </div>
                    ` : ''}
                    ${S.accounts.filter(a => a.role !== 'admin').map(a => `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded mb-2">
                            <div><p class="font-bold">${a.name}</p><p class="text-sm text-gray-600">@${a.username}</p></div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">Enseignant</span>
                        </div>
                    `).join('')}
                `;
            }

            if (S.tab === 'classes' && isAdmin) {
                return `
                    <div class="flex justify-between mb-6">
                        <h2 class="text-2xl font-bold">Classes</h2>
                        <button onclick="showForm('class')" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚ûï Cr√©er</button>
                    </div>
                    ${S.showForm === 'class' ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <input type="text" id="cname" placeholder="Nom classe" class="w-full px-3 py-2 mb-2 border rounded">
                            <select id="level" class="w-full px-3 py-2 mb-2 border rounded">
                                <option value="">Niveau</option>
                                <option>Maternelle</option><option>CP</option><option>CE1</option><option>CE2</option><option>CM1</option><option>CM2</option>
                            </select>
                            <button onclick="createClass()" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Cr√©er</button>
                            <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                        </div>
                    ` : ''}
                    <div class="grid grid-cols-2 gap-4">
                        ${S.classes.map(c => `
                            <div class="p-4 bg-gray-50 rounded">
                                <h3 class="text-xl font-bold text-blue-600">${c.name}</h3>
                                <p class="text-sm text-gray-600 mb-2">${c.level}</p>
                                <select onchange="updateTeacher(${c.id}, this.value)" class="w-full px-3 py-2 border rounded">
                                    <option value="">Non assign√©</option>
                                    ${S.accounts.filter(a => a.role === 'teacher').map(t => `<option value="${t.id}" ${c.teacher_id === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                                <p class="text-sm text-gray-500 mt-2">${S.students.filter(s => s.class_id === c.id).length} √©l√®ve(s)</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (S.tab === 'students' && isAdmin) {
                return `
                    <div class="flex justify-between mb-6">
                        <h2 class="text-2xl font-bold">√âl√®ves</h2>
                        <button onclick="showForm('student')" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚ûï Ajouter</button>
                    </div>
                    ${S.showForm === 'student' ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <input type="text" id="fname" placeholder="Pr√©nom" class="w-full px-3 py-2 mb-2 border rounded">
                            <input type="text" id="lname" placeholder="Nom" class="w-full px-3 py-2 mb-2 border rounded">
                            <input type="date" id="bdate" class="w-full px-3 py-2 mb-2 border rounded">
                            <select id="scid" class="w-full px-3 py-2 mb-2 border rounded">
                                <option value="">Classe</option>
                                ${S.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <button onclick="addStudent()" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Ajouter</button>
                            <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                        </div>
                    ` : ''}
                    <table class="w-full"><thead class="bg-gray-100"><tr><th class="px-4 py-2 text-left">Nom</th><th class="px-4 py-2 text-left">Pr√©nom</th><th class="px-4 py-2 text-left">Classe</th><th class="px-4 py-2 text-left">N√©(e) le</th></tr></thead>
                    <tbody>${S.students.map(s => `<tr class="border-b"><td class="px-4 py-3">${s.last_name}</td><td class="px-4 py-3">${s.first_name}</td><td class="px-4 py-3">${S.classes.find(c=>c.id===s.class_id)?.name||''}</td><td class="px-4 py-3">${s.birth_date}</td></tr>`).join('')}</tbody></table>
                `;
            }

            if (S.tab === 'alerts') {
                if (isAdmin) {
                    return `
                        <div class="flex justify-between mb-6">
                            <h2 class="text-2xl font-bold">Alertes</h2>
                            <button onclick="showForm('alert')" class="px-4 py-2 bg-red-600 text-white rounded-lg">‚ûï Cr√©er</button>
                        </div>
                        ${S.showForm === 'alert' ? `
                            <div class="mb-6 p-4 bg-red-50 rounded-lg">
                                <select id="atitle" class="w-full px-3 py-2 mb-2 border rounded">
                                    <option value="">Type</option>
                                    <option>Alerte intrusion</option><option>Exercice incendie</option><option>√âvacuation</option><option>Confinement</option><option>Incident</option>
                                </select>
                                <textarea id="adesc" placeholder="Description" class="w-full px-3 py-2 mb-2 border rounded h-24"></textarea>
                                <button onclick="createAlert()" class="px-4 py-2 bg-red-600 text-white rounded mr-2">Cr√©er</button>
                                <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                            </div>
                        ` : ''}
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6"><p class="text-sm"><strong>Info:</strong> Visible par tous les enseignants</p></div>
                        ${S.alerts.map(a => `
                            <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded mb-2 flex justify-between">
                                <div><p class="font-bold text-red-800">${a.title}</p><p class="text-sm">${a.description}</p><p class="text-xs text-gray-500 mt-1">Par ${a.created_by} - ${new Date(a.date).toLocaleString()}</p></div>
                                <button onclick="delAlert(${a.id})" class="text-red-600">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    `;
                } else {
                    return `
                        <h2 class="text-2xl font-bold mb-6">Alertes administration</h2>
                        ${S.alerts.length === 0 ? '<p class="text-gray-500">Aucune alerte</p>' : S.alerts.map(a => `
                            <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded mb-2">
                                <p class="font-bold text-red-800">${a.title}</p><p class="text-sm">${a.description}</p><p class="text-xs text-gray-500 mt-1">Par ${a.created_by} - ${new Date(a.date).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    `;
                }
            }

            if (S.tab === 'messages') {
                const msgs = !isAdmin && tc ? S.messages.filter(m => m.class_id === tc.id) : S.messages;
                return `
                    <div class="flex justify-between mb-6">
                        <h2 class="text-2xl font-bold">Messages</h2>
                        ${isAdmin ? `<button onclick="showForm('message')" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚ûï Nouveau</button>` : ''}
                    </div>
                    ${S.showForm === 'message' ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <input type="text" id="mtitle" placeholder="Titre" class="w-full px-3 py-2 mb-2 border rounded">
                            <textarea id="mcontent" placeholder="Contenu" class="w-full px-3 py-2 mb-2 border rounded h-24"></textarea>
                            <select id="mcid" class="w-full px-3 py-2 mb-2 border rounded">
                                <option value="">Classe</option>
                                ${S.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <select id="mcat" class="w-full px-3 py-2 mb-2 border rounded">
                                <option value="information">Information</option><option value="sortie">Sortie</option><option value="annonce">Annonce</option>
                            </select>
                            <button onclick="sendMsg()" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Envoyer</button>
                            <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                        </div>
                    ` : ''}
                    ${msgs.map(m => {
                        const bg = m.category === 'sortie' ? 'bg-green-50 border-green-300' : m.category === 'information' ? 'bg-blue-50 border-blue-300' : 'bg-orange-50 border-orange-300';
                        return `<div class="${bg} p-4 border-l-4 rounded mb-2"><div class="flex justify-between"><h3 class="font-bold">${m.title}</h3><span class="text-xs text-gray-500">${new Date(m.date).toLocaleString()}</span></div><p class="text-sm mt-1">${m.content}</p><p class="text-xs text-gray-500 mt-2">Classe: ${S.classes.find(c=>c.id===m.class_id)?.name} ‚Ä¢ Par: ${m.sender}</p></div>`;
                    }).join('')}
                `;
            }

            if (S.tab === 'homework') {
                const hws = !isAdmin && tc ? S.homework.filter(h => h.class_id === tc.id) : S.homework;
                return `
                    <div class="flex justify-between mb-6">
                        <h2 class="text-2xl font-bold">Cahier de texte</h2>
                        ${!isAdmin && tc ? `<button onclick="showForm('homework')" class="px-4 py-2 bg-blue-600 text-white rounded-lg">‚ûï Ajouter</button>` : ''}
                    </div>
                    ${S.showForm === 'homework' ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <input type="text" id="hsub" placeholder="Mati√®re" class="w-full px-3 py-2 mb-2 border rounded">
                            <textarea id="hdesc" placeholder="Description" class="w-full px-3 py-2 mb-2 border rounded h-24"></textarea>
                            <input type="date" id="hdue" class="w-full px-3 py-2 mb-2 border rounded">
                            <button onclick="addHW()" class="px-4 py-2 bg-blue-600 text-white rounded mr-2">Ajouter</button>
                            <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                        </div>
                    ` : ''}
                    ${hws.map(h => `
                        <div class="p-4 bg-gray-50 rounded border mb-3">
                            <div class="flex justify-between mb-2">
                                <div><h3 class="font-bold text-lg">${h.subject}</h3><p class="text-sm text-gray-600">Classe: ${S.classes.find(c=>c.id===h.class_id)?.name}</p></div>
                                ${isAdmin ? `<button onclick="delHW(${h.id})" class="text-red-600">üóëÔ∏è</button>` : ''}
                            </div>
                            <p class="mb-2">${h.description}</p>
                            <div class="flex justify-between text-sm"><span class="text-gray-500">Pour le: ${h.due_date}</span><span class="text-gray-500">Par ${h.teacher_name}</span></div>
                        </div>
                    `).join('')}
                `;
            }

            if (S.tab === 'attendance' && !isAdmin) {
                return `
                    <h2 class="text-2xl font-bold mb-6">Faire l'appel</h2>
                    ${S.showForm === 'attendance' ? `
                        <div class="mb-6 p-4 bg-green-50 rounded-lg">
                            <p class="mb-3">Classe: ${tc?.name || 'Non assign√©e'}</p>
                            ${tc ? `
                                <div class="space-y-2 mb-4" id="attList">
                                    ${S.students.filter(s => s.class_id === tc.id).map(s => `
                                        <button onclick="toggleAtt(${s.id})" id="att${s.id}" class="w-full p-3 bg-gray-100 hover:bg-gray-200 rounded text-left">
                                            ${s.first_name} ${s.last_name}
                                        </button>
                                    `).join('')}
                                </div>
                                <button onclick="submitAtt()" class="px-4 py-2 bg-green-600 text-white rounded mr-2">Valider</button>
                                <button onclick="S.showForm=null;render()" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                            ` : '<p>Vous n\'avez pas de classe assign√©e</p>'}
                        </div>
                    ` : `<button onclick="showForm('attendance')" class="px-4 py-2 bg-green-600 text-white rounded">Commencer l'appel</button>`}
                `;
            }

            if (S.tab === 'attendance-view' && isAdmin) {
                return `
                    <h2 class="text-2xl font-bold mb-6">Appels re√ßus</h2>
                    <table class="w-full"><thead class="bg-gray-100"><tr><th class="px-4 py-2 text-left">√âl√®ve</th><th class="px-4 py-2 text-left">Classe</th><th class="px-4 py-2 text-left">Statut</th><th class="px-4 py-2 text-left">Raison</th><th class="px-4 py-2 text-left">Date</th><th class="px-4 py-2 text-left">Enseignant</th></tr></thead>
                    <tbody>${S.attendance.map(a => `<tr class="border-b"><td class="px-4 py-3">${a.student_name}</td><td class="px-4 py-3">${a.class_name}</td><td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${a.present?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${a.present?'Pr√©sent':'Absent'}</span></td><td class="px-4 py-3">${a.reason||'-'}</td><td class="px-4 py-3">${a.date}</td><td class="px-4 py-3">${a.teacher_name}</td></tr>`).join('')}</tbody></table>
                `;
            }

            if (S.tab === 'schedule' && !isAdmin && tc) {
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
                const scheds = S.schedules.filter(s => s.class_id === tc.id);
                return `
                    <h2 class="text-2xl font-bold mb-6">Emploi du temps - ${tc.name}</h2>
                    <div class="grid grid-cols-5 gap-4">
                        ${days.map(d => `
                            <div>
                                <h3 class="font-bold text-center p-3 bg-gray-200 rounded-t">${d}</h3>
                                <div class="space-y-2 p-2 bg-gray-50 rounded-b min-h-96">
                                    ${scheds.filter(s => s.day === d).sort((a,b) => a.start_time.localeCompare(b.start_time)).map(s => `
                                        <div class="p-3 rounded text-white" style="background-color:${s.color}">
                                            <p class="font-semibold text-sm">${s.subject}</p>
                                            <p class="text-xs">${s.start_time} - ${s.end_time}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return '<p class="text-gray-500">Section non disponible</p>';
        }

        function login() {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            const user = S.accounts.find(a => a.username === u && a.password === p);
            if (user) { S.user = user; render(); }
            else alert('Identifiants incorrects');
        }

        function logout() { S.user = null; S.tab = 'dashboard'; render(); }
        function tab(t) { S.tab = t; S.showForm = null; render(); }
        function showForm(f) { S.showForm = f; render(); }

        async function createAccount() {
            const data = {name: document.getElementById('name').value, username: document.getElementById('username').value, password: document.getElementById('password').value, role: 'teacher'};
            const r = await supabase.from('accounts').insert([data]);
            if (r.data) { S.accounts.push(...r.data); S.showForm = null; render(); }
        }

        async function createClass() {
            const data = {name: document.getElementById('cname').value, level: document.getElementById('level').value, teacher_id: null};
            const r = await supabase.from('classes').insert([data]);
            if (r.data) { S.classes.push(...r.data); S.showForm = null; render(); }
        }

        async function updateTeacher(cid, tid) {
            await supabase.from('classes').update({teacher_id: tid ? parseInt(tid) : null}).eq('id', cid);
            S.classes = S.classes.map(c => c.id === cid ? {...c, teacher_id: tid ? parseInt(tid) : null} : c);
            await init();
        }

        async function addStudent() {
            const data = {first_name: document.getElementById('fname').value, last_name: document.getElementById('lname').value, birth_date: document.getElementById('bdate').value, class_id: parseInt(document.getElementById('scid').value)};
            const r = await supabase.from('students').insert([data]);
            if (r.data) { S.students.push(...r.data); S.showForm = null; render(); }
        }

        async function createAlert() {
            const data = {title: document.getElementById('atitle').value, description: document.getElementById('adesc').value, created_by: S.user.name, date: new Date().toISOString()};
            const r = await supabase.from('alerts').insert([data]);
            if (r.data) { S.alerts.push(...r.data); S.showForm = null; render(); }
        }

        async function delAlert(id) {
            if (!confirm('Supprimer ?')) return;
            await supabase.from('alerts').delete().eq('id', id);
            S.alerts = S.alerts.filter(a => a.id !== id);
            render();
        }

        async function sendMsg() {
            const data = {title: document.getElementById('mtitle').value, content: document.getElementById('mcontent').value, class_id: parseInt(document.getElementById('mcid').value), category: document.getElementById('mcat').value, sender: S.user.name, date: new Date().toISOString()};
            const r = await supabase.from('messages').insert([data]);
            if (r.data) { S.messages.push(...r.data); S.showForm = null; render(); }
        }

        async function addHW() {
            const tc = S.classes.find(c => c.teacher_id === S.user.id);
            if (!tc) { alert('Pas de classe'); return; }
            const data = {subject: document.getElementById('hsub').value, description: document.getElementById('hdesc').value, due_date: document.getElementById('hdue').value, class_id: tc.id, teacher_id: S.user.id, teacher_name: S.user.name, created_date: new Date().toISOString()};
            const r = await supabase.from('homework').insert([data]);
            if (r.data) { S.homework.push(...r.data); S.showForm = null; render(); }
        }

        async function delHW(id) {
            if (!confirm('Supprimer ?')) return;
            await supabase.from('homework').delete().eq('id', id);
            S.homework = S.homework.filter(h => h.id !== id);
            render();
        }

        let presentIds = [];
        function toggleAtt(id) {
            const btn = document.getElementById('att' + id);
            if (presentIds.includes(id)) {
                presentIds = presentIds.filter(i => i !== id);
                btn.className = 'w-full p-3 bg-gray-100 hover:bg-gray-200 rounded text-left';
            } else {
                presentIds.push(id);
                btn.className = 'w-full p-3 bg-green-500 text-white font-semibold rounded text-left';
            }
        }

        async function submitAtt() {
            const tc = S.classes.find(c => c.teacher_id === S.user.id);
            if (!tc) return;
            const studs = S.students.filter(s => s.class_id === tc.id);
            const reasons = ['Enfant malade', 'Retard', 'Probl√®me de route', 'Rendez-vous m√©dical', 'Absence justifi√©e'];
            const data = studs.map(s => ({
                student_id: s.id,
                student_name: `${s.first_name} ${s.last_name}`,
                class_id: tc.id,
                class_name: tc.name,
                present: presentIds.includes(s.id),
                reason: presentIds.includes(s.id) ? null : reasons[Math.floor(Math.random() * reasons.length)],
                date: new Date().toISOString().split('T')[0],
                teacher_name: S.user.name
            }));
            const r = await supabase.from('attendance').insert(data);
            if (r.data) { 
                S.attendance.push(...r.data); 
                presentIds = [];
                S.showForm = null; 
                alert('Appel enregistr√© !');
                render(); 
            }
        }

        init();
    </script>
</body>
</html>
